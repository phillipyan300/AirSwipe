# AirSwipe Development Log

## Session: 2026-01-26

**Started:** 2026-01-26
**Status:** In Progress

---

## ğŸ“‹ Master Plan (from NEWDESIGNDOC.md)

Build a Mac-only gesture system using ultrasonic Doppler:
1. **Part 1 (MVP):** Left vs right swipe classifier (plus "none")
2. **Part 2 (Upgrade):** Continuous motion tracking visualization

---

## ğŸ¯ Milestones

| # | Milestone | Status | Notes |
|---|-----------|--------|-------|
| 0 | Environment & module structure | âœ… DONE | Created 10 modules |
| 1 | Carrier scan & audio I/O | âœ… DONE | AudioDuplex, CarrierScanner |
| 2 | DSP pipeline with background subtraction | âœ… DONE | DSP class, DopplerFeatures |
| 3 | Segmentation + baseline classifier | âœ… DONE | GestureSegmenter, BaselineClassifier |
| 4 | Dataset collection + CNN pipeline | âœ… DONE | DatasetCollector, TinyCNN |
| 5 | Motion tracking (Part 2) | âœ… DONE | MotionTracker, KalmanTracker |

---

## âœ… What Has Been Done

### 1. Project Structure Created
```
AirSwipe/
â”œâ”€â”€ airswipe/
â”‚   â”œâ”€â”€ __init__.py      # Package init
â”‚   â”œâ”€â”€ config.py        # All configuration parameters
â”‚   â”œâ”€â”€ audio_tx.py      # Tone generation (AudioTx class)
â”‚   â”œâ”€â”€ audio_rx.py      # Mic capture (AudioRx, AudioDuplex classes)
â”‚   â”œâ”€â”€ dsp.py           # STFT, features, background subtraction, CarrierScanner
â”‚   â”œâ”€â”€ segmentation.py  # GestureSegmenter, GestureLabel, GestureEvent
â”‚   â”œâ”€â”€ model.py         # BaselineClassifier (logistic reg) + TinyCNN (PyTorch)
â”‚   â”œâ”€â”€ tracker.py       # MotionTracker (EMA), KalmanTracker
â”‚   â”œâ”€â”€ ui.py            # ConsoleUI, MatplotlibUI
â”‚   â””â”€â”€ dataset.py       # DatasetCollector, DatasetProcessor
â”œâ”€â”€ main.py              # CLI entry point with subcommands
â”œâ”€â”€ requirements.txt     # Dependencies
â”œâ”€â”€ README.md            # Usage documentation
â””â”€â”€ cursor_log/          # This log folder
```

### 2. Key Features Implemented

#### Audio System
- **AudioTx:** Continuous tone generation with phase continuity
- **AudioRx:** Microphone capture with circular buffer
- **AudioDuplex:** Combined TX/RX for synchronized operation

#### Signal Processing (dsp.py)
- STFT computation with configurable window/hop
- Background subtraction via running median
- Feature extraction: E_above, E_below, D(t), A(t)
- **CarrierScanner:** Automatic frequency selection (16-19.5 kHz)

#### Gesture Detection (segmentation.py)
- State machine: IDLE â†’ ONSET â†’ ACTIVE
- Energy thresholding with cooldown
- Classification based on signed Doppler integral

#### Classification (model.py)
- **BaselineClassifier:** Logistic regression on hand-crafted features
  - Features: mean_d, max_d, slope_d, signed_area, duration, max_a
- **TinyCNN:** 3-layer Conv2D network for spectrogram patches
  - Input: (T=64, F=64) log-magnitude patches
  - Output: 3 classes (none, left, right)

#### Motion Tracking (tracker.py)
- **MotionTracker:** EMA smoothing for v_hat, integration for x_hat
- **KalmanTracker:** Kalman filter for smoother tracking
- Drift control during idle periods

#### Visualization (ui.py)
- **ConsoleUI:** Terminal-based activity bars
- **MatplotlibUI:** Real-time spectrogram, feature plots, position dot

#### Dataset Tools (dataset.py)
- **DatasetCollector:** Interactive labeled sample recording
- **DatasetProcessor:** Feature extraction, train/val/test splits

### 3. CLI Commands
```bash
python main.py scan              # Find best carrier frequency
python main.py visualize         # Real-time spectrogram
python main.py visualize --tracking  # With motion plots
python main.py detect            # Gesture detection
python main.py track             # Motion tracking demo
python main.py track --kalman    # With Kalman filter
python main.py collect           # Collect training data
python main.py train --dataset   # Train classifier
```

---

## â³ What Remains To Be Done

### Immediate
- [x] Create virtual environment and install dependencies âœ… DONE
- [x] Test that all modules import correctly âœ… DONE  
- [ ] Run basic smoke test (needs audio hardware)

### Testing & Validation
- [ ] Test carrier scan on actual Mac hardware
- [ ] Verify spectrogram shows Doppler shifts with hand motion
- [ ] Tune activity threshold for real-world use
- [ ] Collect real dataset (100+ samples per class)
- [ ] Train and evaluate baseline classifier
- [ ] Train CNN if baseline insufficient

### Potential Improvements
- [ ] Add pyqtgraph for faster UI updates
- [ ] Implement USB mic fallback for debugging
- [ ] Add gesture actions (desktop switching, etc.)
- [ ] Add configuration file loading/saving
- [ ] Add logging framework

---

## ğŸ”§ Configuration Defaults

| Parameter | Value | Description |
|-----------|-------|-------------|
| sample_rate | 48000 Hz | Audio sample rate |
| carrier_freq | 18500 Hz | Ultrasonic carrier |
| fft_size | 2048 | ~23.4 Hz resolution |
| hop_size | 512 | ~10.7 ms time resolution |
| doppler_bandwidth | 500 Hz | Analysis band around carrier |
| activity_threshold | 0.5 | Event detection threshold |
| cooldown_sec | 0.5 | Between gestures |
| velocity_ema_alpha | 0.85 | Tracking smoothing |

---

## ğŸ“ Notes

- The old monolithic `airswipe.py` was deleted in favor of the modular architecture
- Design follows NEWDESIGNDOC.md specifications closely
- All modules have docstrings and type hints
- CNN requires PyTorch (optional dependency)

---

## ğŸ• Timeline

| Time | Action |
|------|--------|
| Session Start | Read NEWDESIGNDOC.md, analyzed existing code |
| +5 min | Created module structure plan |
| +10 min | Implemented config.py, audio_tx.py, audio_rx.py |
| +15 min | Implemented dsp.py with CarrierScanner |
| +20 min | Implemented segmentation.py, model.py |
| +25 min | Implemented tracker.py, ui.py, dataset.py |
| +30 min | Created main.py CLI, updated README.md |
| +35 min | Created cursor_log folder |
| +40 min | Created venv, installed dependencies |
| +42 min | Verified all modules import successfully âœ… |
| +43 min | CLI help verified working âœ… |

---

## ğŸš€ Ready to Test

The project is now ready for hardware testing. To run:

```bash
cd /Users/phillipyan/Documents/AirSwipe
source venv/bin/activate

# First, find best carrier frequency
python main.py scan

# Then visualize to see Doppler effect
python main.py visualize

# Or run gesture detection
python main.py detect
```

---

*Last updated: 2026-01-26*
